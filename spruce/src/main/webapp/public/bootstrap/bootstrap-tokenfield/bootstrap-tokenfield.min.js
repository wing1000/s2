/* ============================================================
 * bootstrap-tokenfield.js v0.7.0
 * ============================================================
 *
 * Copyright 2013 Sliptree
 * ============================================================ */
!function(c){var g=function(a,b){var e=this;this.$wrapper=c('<div class="tokenfield" />');this.$element=c(a).css({position:"absolute",left:"-10000px"}).prop("tabindex",-1);this.$input=c('<input type="text" class="token-input" />').appendTo(this.$wrapper);this.$mirror=c('<span style="position:absolute; top:-999px; left:0; white-space:pre;"/>');this.$copyHelper=c('<input type="text" />').css({position:"absolute",left:"-10000px"}).prop("tabindex",-1).prependTo(this.$wrapper);this.options=c.extend({},
c.fn.tokenfield.defaults,{tokens:this.$element.val()},b);this.$wrapper.width(this.$element.width());this.$input.css("min-width",this.options.minWidth+"px");c.each("fontFamily fontSize fontWeight fontStyle letterSpacing textTransform wordSpacing textIndent".split(" "),function(a,b){e.$mirror[0].style[b]=e.$input.css(b)});this.$mirror.appendTo("body");this.$wrapper.insertBefore(this.$element);this.$element.prependTo(this.$wrapper);this.setTokens(this.options.tokens);this.listen();if(this.options.autocomplete.source){var d=
c.extend({},this.options.autocomplete,{minLength:this.options.showAutocompleteOnFocus?0:null,position:{my:"left top",at:"left bottom",of:this.$wrapper}});this.$input.autocomplete(d)}};g.prototype={constructor:g,createToken:function(a){"string"===typeof a&&(a={value:a,label:a});var b=this,e=c.trim(a.value),d=a.label.length?c.trim(a.label):e;if(e.length&&(d.length&&!(e.length<this.options.minLength))&&(this.options.allowDuplicates||!c.grep(this.getTokens(),function(a){return a.value===e}).length)){a=
c.Event("beforeCreateToken");a.token={value:e,label:d};this.$element.trigger(a);var f=c('<div class="token" />').attr("data-value",a.token.value).append('<span class="token-label" />').append('<a href="#" class="close" tabindex="-1">&times;</a>');this.$input.before(f);this.$input.css("width",this.options.minWidth+"px");var d=f.find(".token-label"),g=f.find(".close");this.maxTokenWidth||(this.maxTokenWidth=this.$wrapper.width()-g.outerWidth()-parseInt(g.css("margin-left"),10)-parseInt(g.css("margin-right"),
10)-parseInt(f.css("border-left-width"),10)-parseInt(f.css("border-right-width"),10)-parseInt(f.css("padding-left"),10)-parseInt(f.css("padding-right"),10),parseInt(d.css("border-left-width"),10)-parseInt(d.css("border-right-width"),10)-parseInt(d.css("padding-left"),10)-parseInt(d.css("padding-right"),10),parseInt(d.css("margin-left"),10)-parseInt(d.css("margin-right"),10));d.text(a.token.label).css("max-width",this.maxTokenWidth);f.on("mousedown",function(a){b.preventDeactivation=!0}).on("click",
function(a){b.preventDeactivation=!1;if(a.ctrlKey||a.metaKey)return a.preventDefault(),b.toggle(f);b.activate(f,a.shiftKey,a.shiftKey)}).on("dblclick",function(a){b.edit(f)});g.on("click",c.proxy(this.remove,this));d=c.Event("afterCreateToken");d.token=a.token;d.relatedTarget=f;this.$element.trigger(d);this.$element.val(this.getTokensList()).trigger("change");this.update();return this.$input.get(0)}},setTokens:function(a,b){if(a){b||this.$wrapper.find(".token").remove();"string"===typeof a&&(a=a.split(","));
var e=this;c.each(a,function(a,b){e.createToken(b)});return this.$input.get(0)}},getTokens:function(a){var b=[];this.$wrapper.find(".token"+(a?".active":"")).each(function(){b.push({value:c(this).data("value")||c(this).find(".token-label").text(),label:c(this).find(".token-label").text()})});return b},getTokensList:function(a){return c.map(this.getTokens(a),function(a){return a.value}).join(", ")},listen:function(){var a=this;this.$wrapper.on("click",c.proxy(this.focusInput,this));this.$input.on("focus",
c.proxy(this.focus,this)).on("blur",c.proxy(this.blur,this)).on("paste",c.proxy(this.paste,this)).on("keydown",c.proxy(this.keydown,this)).on("keypress",c.proxy(this.keypress,this)).on("keyup",c.proxy(this.keyup,this));this.$copyHelper.on("focus",c.proxy(this.focus,this)).on("blur",c.proxy(this.blur,this)).on("keydown",c.proxy(this.keydown,this)).on("keyup",c.proxy(this.keyup,this));this.$input.on("keydown, keypress, keyup",c.proxy(this.update,this));this.$input.on("autocompletecreate",function(){var b=
a.$wrapper.width()+parseInt(a.$wrapper.css("padding-right"),10)+parseInt(a.$wrapper.css("border-right-width"),10);c(this).data("uiAutocomplete").menu.element.css("min-width",b+"px")}).on("autocompleteopen",function(){a.$input.data("autocomplete-open",!0)}).on("autocompleteclose",function(){a.$input.data("autocomplete-open",!1)}).on("autocompleteselect",function(b,c){a.$input.val("");a.createToken(c.item);return!1})},keydown:function(a){if(this.focused){switch(a.keyCode){case 8:if(!this.$input.is(":focus"))break;
this.lastInputValue=this.$input.val();break;case 37:if(this.$input.is(":focus")){if(0<this.$input.val().length)break;var b=this.$input.prevAll(".token:first");if(!b.length)break;this.preventInputFocus=!0;this.activate(b)}else this.prev(a.shiftKey);a.preventDefault();break;case 38:if(!a.shiftKey)return;if(this.$input.is(":focus")){if(0<this.$input.val().length)break;b=this.$input.prev(".token:last");if(!b.length)return;this.activate(b)}var e=this;this.firstActiveToken.nextAll(".token").each(function(){e.deactivate(c(this))});
this.activate(this.$wrapper.find(".token:first"),!0,!0);a.preventDefault();break;case 39:if(this.$input.is(":focus")){if(0<this.$input.val().length)break;b=this.$input.next(".token:first");if(!b.length)break;this.preventInputFocus=!0;this.activate(b)}else this.next(a.shiftKey);a.preventDefault();break;case 40:if(!a.shiftKey)return;if(this.$input.is(":focus")){if(0<this.$input.val().length)break;b=this.$input.next(".token:first");if(!b.length)return;this.activate(b)}e=this;this.firstActiveToken.prevAll(".token").each(function(){e.deactivate(c(this))});
this.activate(this.$wrapper.find(".token:last"),!0,!0);a.preventDefault();break;case 65:if(0<this.$input.val().length||!a.ctrlKey&&!a.metaKey)break;this.activateAll();a.preventDefault();break;case 9:case 13:if(this.$input.data("autocomplete-open"))break;(this.$input.is(":focus")&&this.$input.val().length||this.$input.data("edit"))&&this.createTokensFromInput(a);if(13===a.keyCode){if(!this.$element.is(":focus")||1!==this.$wrapper.find(".token.active").length)break;this.edit(this.$wrapper.find(".token.active"))}}this.lastKeyDown=
a.keyCode}},keypress:function(a){this.lastKeyPressCode=a.keyCode;this.lastKeyPressCharCode=a.charCode},keyup:function(a){this.preventInputFocus=!1;if(this.focused){switch(a.keyCode){case 8:if(this.$input.is(":focus")){if(this.$input.val().length||this.lastInputValue.length&&8===this.lastKeyDown)break;this.activate(this.$input.prevAll(".token:first"))}else this.remove(a);break;case 46:this.remove(a,"next");break;case 188:if(44!==this.lastKeyPressCharCode||!this.$input.is(":focus")||!this.$input.val())break;
this.createTokensFromInput(a)}this.lastKeyUp=a.keyCode}},focus:function(a){this.focused=!0;this.$wrapper.addClass("focus");this.$input.is(":focus")&&(this.$wrapper.find(".active").removeClass("active"),this.firstActiveToken=null,this.options.showAutocompleteOnFocus&&this.$input.data("uiAutocomplete")&&this.search())},blur:function(a){this.focused=!1;this.$wrapper.removeClass("focus");this.preventDeactivation||this.$element.is(":focus")||(this.$wrapper.find(".active").removeClass("active"),this.firstActiveToken=
null);this.$input.data("edit")&&!this.$input.is(":focus")&&this.createTokensFromInput(a)},paste:function(a){var b=this;setTimeout(function(){b.createTokensFromInput(a)},1)},createTokensFromInput:function(a){if(!(this.$input.val().length<this.options.minLength)){var b=this.getTokensList();this.setTokens(this.$input.val(),!0);if(b!=this.getTokensList()||!this.$input.val().length){this.$input.val("");if(this.$input.data("edit")){this.$input.appendTo(this.$wrapper).data("edit",!1).css("width",this.options.minWidth+
"px");if(!this.preventInputFocus){var c=this;setTimeout(function(){c.$input.focus()},1)}this.$wrapper.css("width",this.$wrapper.data("prev-width"))}a.preventDefault();a.stopPropagation()}}},next:function(a){if(a){var b=this.$wrapper.find(".active:first");if(b&&this.firstActiveToken&&b.index()<this.firstActiveToken.index())return this.deactivate(b)}b=this.$wrapper.find(".active:last").nextAll(".token:first");b.length?this.activate(b,a):this.$input.focus()},prev:function(a){if(a){var b=this.$wrapper.find(".active:last");
if(b&&this.firstActiveToken&&b.index()>this.firstActiveToken.index())return this.deactivate(b)}b=this.$wrapper.find(".active:first").prevAll(".token:first");b.length||(b=this.$wrapper.find(".token:first"));b.length||a?this.activate(b,a):this.$input.focus()},activate:function(a,b,e,d){if(a&&this.$wrapper.find(".token.active").length!==this.$wrapper.find(".token").length){"undefined"===typeof d&&(d=!0);e&&(b=!0);this.$copyHelper.focus();b||(this.$wrapper.find(".active").removeClass("active"),d?this.firstActiveToken=
a:delete this.firstActiveToken);if(e&&this.firstActiveToken){b=this.firstActiveToken.index()-2;e=a.index()-2;var f=this;this.$wrapper.find(".token").slice(Math.min(b,e)+1,Math.max(b,e)).each(function(){f.activate(c(this),!0)})}a.addClass("active");this.$copyHelper.val(this.getTokensList(!0)).select()}},activateAll:function(){var a=this;this.$wrapper.find(".token").each(function(b){a.activate(c(this),0!==b,!1,!1)})},deactivate:function(a){a&&(a.removeClass("active"),this.$copyHelper.val(this.getTokensList(!0)).select())},
toggle:function(a){a&&(a.toggleClass("active"),this.$copyHelper.val(this.getTokensList(!0)).select())},edit:function(a){if(a){var b=a.data("value"),e=a.find(".token-label").text(),d=c.Event("beforeEditToken");d.token={value:b,label:e};this.$element.trigger(d);a.find(".token-label").text(d.token.value);b=a.outerWidth();this.$wrapper.data("prev-width",this.$wrapper.width()).width(this.$wrapper.width());a.replaceWith(this.$input);this.$input.val(d.token.value).select().data("edit",!0).width(b)}},remove:function(a,
b){if(!this.$input.is(":focus")){var e="click"===a.type?c(a.target).closest(".token"):this.$wrapper.find(".token.active");"click"!==a.type&&(b||(b="prev"),this[b]());e.remove();this.$element.val(this.getTokensList()).trigger("removeToken").trigger("change");this.$wrapper.find(".token").length&&"click"!==a.type||this.$input.focus();this.$input.css("width",this.options.minWidth+"px");this.update();a.preventDefault();a.stopPropagation()}},update:function(){var a=this.$input.val();this.$input.data("edit")?
(a||(a=this.$input.prop("placeholder")),a!==this.$mirror.text()&&(this.$mirror.text(a),this.$input.width(this.$mirror.width()+10))):this.$input.width(this.$wrapper.offset().left+this.$wrapper.width()-this.$input.offset().left+5)},focusInput:function(a){c(a.target).closest(".token").length||this.$input.focus()},search:function(){this.$input.autocomplete("search")}};var h=c.fn.tokenfield;c.fn.tokenfield=function(a,b){var e=c(this),d=e.data("tokenfield"),f="object"==typeof a&&a;if("string"===typeof a&&
d&&d[a])return d[a](b);d||e.data("tokenfield",new g(this,f));return this};c.fn.tokenfield.defaults={minWidth:60,minLength:0,allowDuplicates:!1,autocomplete:{},showAutocompleteOnFocus:!1};c.fn.tokenfield.Constructor=g;c.fn.tokenfield.noConflict=function(){c.fn.tokenfield=h;return this}}(window.jQuery);